import { PermissionType } from 'arconnect';
import 'arconnect';
import { Tag } from 'arweave/web/lib/transaction';

import { RGBObject } from '../components/Provider';

/**
 * Compare two permission arrays
 *
 * @param required The permissions that should be in the second array
 * @param existing The permissions the app has
 */
export function comparePermissions(
  required: PermissionType[],
  existing: PermissionType[],
) {
  for (const permission of required) {
    if (!existing.includes(permission)) {
      return false;
    }
  }

  return true;
}

/**
 * Beautify addresses
 *
 * @param address Address to beautify
 */
export function formatAddress(address: string, count = 13) {
  return (
    address.substring(0, count) +
    '...' +
    address.substring(address.length - count, address.length)
  );
}

export const rgbToString = (rgb: RGBObject) => `${rgb.r}, ${rgb.g}, ${rgb.b}`;

/**
 * Call the window.arweaveWallet API and wait for it to be injected,
 * if it has not yet been injected.
 *
 * @param fn Function name
 * @param params Params
 * @returns API result
 */
export async function callWindowApi(fn: string, params: any[] = []) {
  // if it is already injected
  if (window?.arweaveWallet) {
    return await (window as any).arweaveWallet[fn](...params);
  }
  // if it has not yet been injected
  return new Promise((resolve, reject) =>
    window.addEventListener('arweaveWalletLoaded', async () => {
      try {
        resolve(await (window as any).arweaveWallet[fn](...params));
      } catch (e) {
        reject(e);
      }
    }),
  );
}

/**
 * Decode an array of tags
 *
 * @param tags An array of tags
 * @returns An array of decoded tags
 */
export function decodeTags(tags: Tag[]) {
  return tags.map((tag) => {
    try {
      const name = tag.get('name', { decode: true, string: true });
      const value = tag.get('value', { decode: true, string: true });
      return { name, value };
    } catch {
      return tag;
    }
  });
}
